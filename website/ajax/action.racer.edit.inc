<?php

$ok = true;

if (have_permission(EDIT_RACER_PERMISSION)) {
  if (isset($_POST['racer'])) {
    $racerid = $_POST['racer'];
  } else if (isset($_POST['racerid'])) {
    $racerid = $_POST['racerid'];
  } else {
    json_failure('noracer', "No racerid provided.");
    $ok = false;
  }

  $assignments = 'SET racerid = :racerid_again';
  $values = array(':racerid' => $racerid,
                  ':racerid_again' => $racerid);

  if ($ok && isset($_POST['divisionid'])) {
    $division_id = $_POST['divisionid'];
    $assignments .= ', divisionid = :divisionid';
    $values[':divisionid'] = $division_id;
    $row = read_single_row('SELECT classid, rankid FROM Ranks'
                           .' WHERE rankid = (SELECT rankid FROM Divisions'
                           .'                 WHERE divisionid = :divisionid)',
                           array(':divisionid' => $division_id), PDO::FETCH_ASSOC);
    if ($row) {
      $assignments .= ', classid = :classid, rankid = :rankid';
      $values[':classid'] = $row['classid'];
      $values[':rankid'] = $row['rankid'];
    }
  }
  if ($ok && isset($_POST['rankid'])) {
    $rankid = $_POST['rankid'];
    $classid = read_single_value('SELECT classid FROM Ranks WHERE rankid = :rankid',
                                 array(':rankid' => $rankid));
    if (!$classid) {
      json_failure('noclass', "No class for rankid $rankid");
      $ok = false;
    }

    $assignments .= ', rankid = :rankid';
    $values[':rankid'] = $rankid;
    $assignments .= ', classid = :classid';
    $values[':classid'] = $classid;
  }
  if (isset($_POST['firstname'])) {
    $assignments .= ', firstname = :firstname';
    $values[':firstname'] = trim($_POST['firstname']);
  }
  if (isset($_POST['lastname'])) {
    $assignments .= ', lastname = :lastname';
    $values[':lastname'] = trim($_POST['lastname']);
  }
  if ($ok && isset($_POST['carno'])) {
    $assignments .= ', carnumber = :carnumber';
    $values[':carnumber'] = trim($_POST['carno']);
    if (read_single_value('SELECT COUNT(*) FROM RegistrationInfo'
                          .' WHERE carnumber = :carnumber'
                          .' AND racerid <> :racerid',
                          array(':carnumber' => $values[':carnumber'],
                                ':racerid' => $racerid)) > 0) {
      json_out('warning', array("Duplicate car number $values[carnumber]"));
    }
  }
  if (isset($_POST['carname'])) {
    $assignments .= ', carname = :carname';
    $values[':carname'] = trim($_POST['carname']);
  }
  if (isset($_POST['exclude'])) {
    $assignments .= ', exclude = :exclude';
    $values[':exclude'] = $_POST['exclude'];
  }

  if ($ok) {
    $new_roundid = read_single_value('SELECT roundid FROM Rounds WHERE round = 1 AND classid = :classid',
                                     array(':classid' => $classid));

    $old_classid = read_single_value('SELECT classid FROM RegistrationInfo WHERE racerid = :racerid',
                                     array(':racerid' => $racerid));
    $old_roundid = read_single_value('SELECT roundid FROM Rounds WHERE round = 1 AND classid = :classid',
                                     array(':classid' => $old_classid));

    $ok = take_action_silently('UPDATE RegistrationInfo '.$assignments
                               .' WHERE racerid = :racerid', $values);
  }
  if ($ok && isset($classid)) {
    $ok = take_action_silently('UPDATE Roster'
                               .' SET roundid = :new_roundid,'
                               .'     classid = :classid'
                               .' WHERE racerid = :racerid'
                               .' AND roundid = :old_roundid',
                               array(':new_roundid' => $new_roundid,
                                     ':classid' => $classid,
                                     ':racerid' => $racerid,
                                     ':old_roundid' => $old_roundid));
  }

  if ($ok) {
    json_success();
  } else {
    json_failure('sql', "$info[0]-$info[1] $sql failed: $info[2]");
  }
} else {
  json_not_authorized();
}
?>